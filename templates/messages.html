<!DOCTYPE html>
<html>
<head>
    <title>Сообщения</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="sidebar">
        <div class="profile-card">
            <img src="{% if user[5] %}{{ url_for('static', filename='uploads/' + user[5]) }}{% else %}{{ url_for('static', filename='uploads/default_avatar.png') }}{% endif %}" alt="Avatar">
            <h3>{{ user[1] }}</h3>
            <p>{{ user[4] or 'Статус не указан' }}</p>
        </div>
        <div class="nav">
    <a href="{{ url_for('feed.feed') }}">
        <i class="fas fa-newspaper"></i> Новости
    </a>
    <a href="{{ url_for('profile.profile') }}">
        <i class="fas fa-user"></i> Профиль
    </a>
    <a href="{{ url_for('gallery.gallery') }}">
        <i class="fas fa-images"></i> Фотографии
    </a>
    <a href="{{ url_for('messages.messages') }}" class="active">
        <i class="fas fa-comments"></i> Сообщения
    </a>
    <a href="{{ url_for('friends.friends') }}">
        <i class="fas fa-user-friends"></i> Друзья
    </a>
    <a href="{{ url_for('static.logout') }}">
        <i class="fas fa-sign-out-alt"></i> Выйти
    </a>
</div>
    </div>

    <div class="content">
        <div class="friends-list">
            <h2>Диалоги</h2>
            {% for friend in friends %}
            <div class="friend-item {% if friend_id == friend[0] %}active{% endif %}" onclick="location.href='{{ url_for('messages.messages', friend_id=friend[0]) }}'">
                <img src="{% if friend[2] %}{{ url_for('static', filename='uploads/' + friend[2]) }}{% else %}{{ url_for('static', filename='uploads/default_avatar.png') }}{% endif %}" alt="Avatar">
                <div class="friend-info">
                    <h3>{{ friend[1] }}</h3>
                    <p>Последнее сообщение...</p>
                </div>
            </div>
            {% endfor %}
        </div>

<div class="chat-container">
    {% if friend_id %}
    <div class="chat-header">
        <div class="chat-avatar">
            <img src="{% if active_friend[5] %}{{ url_for('static', filename='uploads/' + active_friend[5]) }}{% else %}{{ url_for('static', filename='uploads/default_avatar.png') }}{% endif %}" alt="Аватар {{ active_friend[1] }}">
            <div class="chat-status {% if active_friend[6] %}chat-status-online{% endif %}"></div>
        </div>
        <div class="chat-info">
            <h3>{{ active_friend[1] }}</h3>
            <p>
                {% if active_friend[6] %}
                    онлайн
                {% else %}
                    был(а) {{ active_friend[7].strftime('%H:%M') if active_friend[7] else 'недавно' }}
                {% endif %}
            </p>
        </div>
        <div class="chat-actions">
            <button><i class="fas fa-phone-alt"></i></button>
            <button><i class="fas fa-video"></i></button>
            <button><i class="fas fa-ellipsis-v"></i></button>
        </div>
    </div>
    
            
            <div class="chat-messages" id="chat-messages">
                {% for msg in messages %}
                <div class="message {% if msg[1] == session['user_id'] %}sent{% else %}received{% endif %}">
                    <div class="message-text">{{ msg[3] }}</div>
                    <div class="message-time">{{ msg[4] }}</div>
                </div>
                {% endfor %}
            </div>
            
            <div class="typing-indicator" id="typing-indicator">
                {{ active_friend[1] }} печатает...
            </div>
            
            <div class="chat-input">
                <button id="attach-button" style="margin-right:10px;"><i class="fas fa-paperclip"></i></button>
                <input type="file" id="file-input" style="display: none;">
                <textarea id="message-input" placeholder="Напишите сообщение..."></textarea>
                <button id="send-button"><i class="fas fa-paper-plane"></i></button>
            </div>
            {% else %}
            <div class="empty-chat">
                <i class="fas fa-comments"></i>
                <h3>Выберите диалог</h3>
                <p>Начните общение с вашими друзьями</p>
            </div>
            {% endif %}
        </div>
    </div>


    
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const socket = io();
            const userId = {{ session['user_id'] }};
            const friendId = {{ friend_id if friend_id else 0 }};
            const chatMessages = document.getElementById('chat-messages');
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-button');
            const typingIndicator = document.getElementById('typing-indicator');
            
            // Подключение к WebSocket
            socket.on('connect', function() {
                if (friendId) {
                    socket.emit('join_chat', { friend_id: friendId });
                }
            });

            // Отправка сообщения
            function sendMessage() {
                const content = messageInput.value.trim();
                if (content && friendId) {
                    socket.emit('send_message', {
                        receiver_id: friendId,
                        content: content
                    });
                    messageInput.value = '';
                }
            }

            sendButton.addEventListener('click', sendMessage);
            
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Отслеживание набора текста
            messageInput.addEventListener('input', function() {
                if (messageInput.value.trim() !== '') {
                    socket.emit('typing', { receiver_id: friendId });
                }
            });

            // Получение новых сообщений
            socket.on('receive_message', function(data) {
                const isSent = data.sender_id == userId;
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
                
                messageDiv.innerHTML = `
                    <div class="message-text">${data.content}</div>
                    <div class="message-time">${new Date().toLocaleTimeString()}</div>
                `;
                
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            });

            // Уведомление о наборе текста
            socket.on('user_typing', function(data) {
                if (data.sender_id === friendId) {
                    typingIndicator.style.display = 'block';
                    setTimeout(() => {
                        typingIndicator.style.display = 'none';
                    }, 2000);
                }
            });
            
            // Загрузка истории сообщений
            if (friendId) {
                fetch(`/api/messages/${friendId}`)
                    .then(response => response.json())
                    .then(data => {
                        data.messages.forEach(msg => {
                            const isSent = msg.sender_id == userId;
                            const messageDiv = document.createElement('div');
                            messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
                            
                            messageDiv.innerHTML = `
                                <div class="message-text">${msg.content}</div>
                                <div class="message-time">${msg.timestamp}</div>
                            `;
                            
                            chatMessages.appendChild(messageDiv);
                        });
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    });
            }
        });
    </script>
    <button class="theme-toggle" id="themeToggle">
        <i class="fas fa-moon"></i>
    </button>
    <script src="{{ url_for('static', filename='js/theme.js') }}"></script>
</body>
</html>